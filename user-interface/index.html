<html>

<head>
  <title>RollenBollen</title>
  <!-- <!– Load React. afblijven met de tengels –>
      <!– Note: when deploying, replace “development.js” with “production.min.js”. –> -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link rel="stylesheet" href="stylesheet.css" />
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    window.onload = function () {
      function App(props) {
        const apiLink = 'https://rollenbollen.azurewebsites.net/api/'

        const [cursor, setCursor] = React.useState("#C8EFF9");
        const [grids, setGrids] = React.useState([]);
        const [bolts, setBolts] = React.useState([]);

        React.useEffect(() => {
          const getMaze= async () => {
            const response = await fetch(apiLink + 'maze');
            const json = await response.json();

            const maze = json.maze // JSON is object with property 'maze'

            let array = []
            for(var i = 0; i < maze.length; i++) {
              for(var j = 0; j < maze[i].length; j++) {
                array.push(
                  {
                    index: i * 10 + j, 
                    util: maze[i][j] == 0 ? 
                      ('#C8EFF9') : //available
                      ('#ff0000')   //obstacle
                  }
                )
              }
            }  
            setGrids(array)
          }
          
          getMaze()
        }, []); // remove brackets if you want to loop request the server (to get live position bolt)

        const setMaze= async (x, y) => { // handles toggle of grid by x and y
          let param = '?x=' + x + '&y=' + y + '&v=' + (cursor == '#C8EFF9'? ('0') : ('1'))
          const response = await fetch(apiLink + 'maze' + param);
          const json = await response.json();
        }

        React.useEffect(() => {
          const getBolts= async () => {
            const response = await fetch(apiLink + 'bolt');
            const json = await response.json();
            setBolts(await json)

            let array = grids
            json.map((element) => {
              array[element.position.x * 10 + element.position.y].util = '#022449'
              setGrids(array)
              // console.log(array)
            }) // does this work?
          }
          
          getBolts()
        }) // keeps refreshing, TODO: add cooldown of 1s

        return (
          <div className="container">
            <div className="side-container">
              <ButtonView setCursor={setCursor} />
              {bolts != [] ? <BoltView bolts={bolts} onClick={() =>console.log(grids)}/> : null}
            </div>
            {grids != [] ? (<GridView cursor={cursor} grids={grids} setMaze={setMaze} />) : (null)}  
          </div>
        );
      }
      ReactDOM.render(<App />, document.getElementById("root"));

      function ButtonView(props) {
        return (
          <div className="button-div">
            <div
              className="button"
              style={{ backgroundColor: "#C8EFF9" }}
              onClick={() => props.setCursor("#C8EFF9")}
            >
              <h2 style={{ color: "grey" }}>Beschikbaar</h2>
            </div>
            <div
              className="button"
              style={{ backgroundColor: "#ff0000" }}
              onClick={() => props.setCursor("#ff0000")}
            >
              <h2>Obstakel</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#ffca2c" }}>
              <h2>Tussenstop</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#022449" }}>
              <h2>Positie</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#62C7A5" }}>
              <h2>Doel</h2>
            </div>
          </div>
        );
      }

      function BoltView(props) {
        return (
          <div className="bolt-div">{props.bolts.map((element, index) => (
            <div key={element.id}
              className="bolt" 
              style={{ backgroundColor: "#022449" }}
            >
              <h3>ID: {element.id}, POS: {element.position.x.toString() + element.position.y.toString()}</h3>
            </div>
          ))}
          </div>
        )
      }

      function GridView(props) {

        const changeGrid = (item) => {
          // calculate x and y based on grid position
          // x and y are flipped because api contains an error
          props.setMaze(grids[item].index % 10, Math.floor(grids[item].index / 10))
        };

        return (
          <div className="box-map">
            <div className="grid-container">
                 {props.grids.map((element, index) => (
                  <Grid
                    item={element}
                    key={props.grids[index].index}
                    changeGrid={() => changeGrid(index)}
                    cursor={props.cursor}
                  /> 
                ))
              }
            </div>
          </div>
        );
      }
    };

    function Grid(props) {
      const [color, setColor] = React.useState(props.item.util);

      React.useEffect(() => {
          setColor(props.item.util)
      }, [props.item.util]) // if color changes, re-render

      const onChangeGrid = () => {
        if (props.cursor != color) {
          props.changeGrid();
          }
        }

      return (
        <div
          className="grid-item"
          style={{ backgroundColor: color }}
          onClick={() => {
            setColor(props.cursor); // this is needed
            onChangeGrid();
          }}
        >
          {props.item.index}
        </div>
      );
    }
    
  </script>
</body>

</html>