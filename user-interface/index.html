<html>

<head>
  <title>RollenBollen</title>
  <!-- <!– Load React. afblijven met de tengels –>
      <!– Note: when deploying, replace “development.js” with “production.min.js”. –> -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link rel="stylesheet" href="stylesheet.css" />
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
  // TODO: terugveranderen van geel naar lichtblauw wanneer bolt pad aflegt
// TODO: FR12; af te leggen pad weergeven COULD
// TODO: FR13; server reset knop 
// TODO: FR14; aansturen per bolt en aansturen dichtsbijzijnde (tov doel) COULD
// TODO: FR15; alle bolts naar 'home' sturen knop
    window.onload = function () {
      function App(props) {
        const apiLink = 'https://rollenbollen.azurewebsites.net/api/'

        const [cursor, setCursor] = React.useState("#C8EFF9");
        const [grids, setGrids] = React.useState([]);
        const [bolts, setBolts] = React.useState([]);

        const getMaze= async () => {
            const response = await fetch(apiLink + 'maze');
            const json = await response.json();

            const maze = json.maze // JSON is object with property 'maze'

            let array = []
            for(var i = 0; i < maze.length; i++) {
              for(var j = 0; j < maze[i].length; j++) {
                array.push(
                  {
                    index: i * 10 + j, 
                    util: maze[i][j] == 0 ? 
                      ('#C8EFF9') : //available
                      ('#e71d07')   //obstacle
                  }
                )
              }
            }  
            setGrids(array)
          }

        React.useEffect(() => {
          getMaze()
        }, []); // remove brackets if you want to loop request the server

        const setMaze= async (x, y) => { // handles toggle of grid by x and y
          let param = '?x=' + x + '&y=' + y + '&v=' + (cursor == '#C8EFF9'? ('0') : ('1'))
          const response = await fetch(apiLink + 'maze' + param);
          const json = await response.json();
        }

        React.useEffect(() => {
          // const getPath = async (id) => { 
          //   const response = await fetch(apiLink + 'bolt/' + id + '/path');
          //   const json = await response.json();
          //   return await json
          // }

          const getBolts = async () => {
            console.log('begin')
            const response = await fetch(apiLink + 'bolt');
            const json = await response.json();
            setBolts(await json)

            let array = grids
            if (bolts.length > 0) {
              bolts.map((element) => {
                // current position
                // array[element.position.x * 10 + element.position.y].util = '#fcd200'
                
                // when goal is reached
                if (element.next_move.x * 10 + element.next_move.y == element.position.x * 10 + element.position.y) {
                  // if (element.position.x * 10 + element.position.y == '##42b132') {
                  //   console.log('aaaaaaaaaaaaaaaaaaaaaaaaaaaa')
                  //   getMaze()
                  // }
                  
                  array[element.position.x * 10 + element.position.y].util = '#009ddb' //overrides

                  
                  

                  
                  // TODO: remove all passed grids here
                } else { // goal hasn't been reached
                  if (array[element.next_move.x * 10 + element.next_move.y].util != '#42b132') {
                    array[element.next_move.x * 10 + element.next_move.y].util = '#42b132'
                  }
                  
                  (async () => {
                    const response = await fetch(apiLink + 'bolt/' + element.id + '/path');
                    const json = await response.json();
                    console.log(await json)
                    if (json.hasOwnProperty('path')) {
                      console.log('path')
                      json.path.map((element) => { 
                        if (array[element[0] * 10 + element[1]].util != '#fcd200') {
                          array[element[0] * 10 + element[1]].util = '#fcd200'
                        }
                    })
                    } 
                  })()
                  

                  console.log('end')
                } 
                // console.log('id: ', element.id, array[element.position.x * 10 + element.position.y].util)
              })
              setGrids(array)
            }
          }

          if (grids != []) {
            getBolts()
          }
        }) // TODO: needs to keep refreshing, should work (json.map function is een onderkruipsel)

        // React.useEffect(() => {
        //   console.log('bolt changed')
        // }, [bolts]) // when bolts changes, do this

        return (
          <div className="app-container">
            <audio controls>
                <source src="https://vgmsite.com/soundtracks/super-mario-64-soundtrack/zqtpbfkskm/06%20Slider.mp3" type="audio/mpeg"/>
            </audio>
            <div className="container">
              <div className="side-container">
                <ButtonView setCursor={setCursor} />
              </div>
              {grids != [] ? (<GridView cursor={cursor} grids={grids} setMaze={setMaze} />) : (null)}  

              {bolts != [] ? <BoltView bolts={bolts} onClick={() =>console.log(grids)}/> : null}
              
            </div>
            <div className="title-view">
              <img src="https://fontmeme.com/permalink/211007/ee6670dba76f4367bd3d070b9a3cb143.png" alt="super-mario-lettertype" />
            </div>
          </div>
        );
      }
      ReactDOM.render(<App />, document.getElementById("root"));

      function ButtonView(props) {
        return (
          <div className="button-div">
            <div
              className="button"
              style={{ backgroundColor: "#C8EFF9" }}
              onClick={() => props.setCursor("#C8EFF9")}
            >
              <h2 style={{ color: "grey" }}>Beschikbaar</h2>
            </div>
            <div
              className="button"
              style={{ backgroundColor: "#e71d07" }}
              onClick={() => props.setCursor("#e71d07")}
            >
              <h2>Obstakel</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#fcd200" }}>
              <h2>Tussenstop</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#009ddb" }}>
              <h2>Positie</h2>
            </div>
            <div className="button" style={{ backgroundColor: "#42b132" }}>
              <h2>Doel</h2>
            </div>
            <div 
              className="button" 
              style={{ backgroundColor: "#fc9803" }}
              onClick={() => {
                fetch('https://rollenbollen.azurewebsites.net/api/' + 'reset') // works, but logs error
              }}
            >
              <h2>Reset BOLTs</h2>
            </div>
            <div 
              className="button" 
              style={{ backgroundColor: "#b103fc" }}
              onClick={() => {
                fetch('https://rollenbollen.azurewebsites.net/api/' + 'home') // sends all connected BOLTs home
              }}
            >
              <h2>Thuisfront</h2>
            </div>
          </div>
        );
      }

      function BoltView(props) {
        return (
          <div className="bolt-div">{props.bolts.map((element, index) => (
            <div key={element.id}
              className="bolt" 
              style={{ backgroundColor: "#009ddb" }}
            >
              <h3>ID: {element.id}, POS: {element.position.x.toString() + element.position.y.toString()}</h3>
            </div>
          ))}
          </div>
        )
      }

      function GridView(props) {

        const changeGrid = (item) => {
          // calculate x and y based on grid position
          // x and y are flipped because api contains an error
          props.setMaze(props.grids[item].index % 10, Math.floor(props.grids[item].index / 10))
        };

        return (
          <div className="box-map">
            <div className="grid-container">
              {props.grids.map((element, index) => (
                <Grid
                  item={element}
                  key={props.grids[index].index}
                  changeGrid={() => changeGrid(index)}
                  cursor={props.cursor}
                /> 
              ))}
            </div>
          </div>
        );
      }
    };

    function Grid(props) {
      const [color, setColor] = React.useState(props.item.util);

      React.useEffect(() => {
        console.log('render grid')
        setColor(props.item.util)
      }, [props.item.util]) // if color changes, re-render


      const onChangeGrid = () => { 
        if (props.cursor != color) {
          props.changeGrid();
        }
      }

      return (
        <div
          className="grid-item"
          style={{ backgroundColor: color }}
          onClick={() => {
            setColor(props.cursor); // this is needed
            onChangeGrid();
          }}
        >
          {props.item.index}
        </div>
      );
    }
    
  </script>
</body>

</html>